---
title: 'Team Data Table: Report 3'
author: "Savet Hong"
date: "`r format(Sys.Date(), '%b %d, %Y')`"
output:
     word_document: default   
     html_document: default 
     
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding,
  output_dir = ".", output_format = "all") })     
     
---

To use the code in this Rmarkdown for each Team/Model in separate Rmarkdown, please do as follow:
  
- ensure that all library packages (as listed in the library chunk) are installed
- copy chuck containing R libraries 
- copy appropriate section of code
+ datafile, setup, output for each model
+ table for base and experiment(s)
- include "agg_bc_exp1.xlsx" and/or "agg_exp2_exp3.xlsx" in the same folder, if not then change file pathway to the data source    

```{r library, include=FALSE}

library(readxl)
library(dplyr)
library(tibble)
library(tidyr)
library(ggplot2)
library(htmlTable)
library(huxtable)

```


## Aggregate Model

```{r dtfiles, include=FALSE}
# Read in files related to Experimental design
dgn_bc <- read_excel("agg_bc_exp1.xlsx", col_names = FALSE, range = "A12:B15")
dgn_e1 <- read_excel("agg_bc_exp1.xlsx", col_names = FALSE, range = "A265:B268")
dgn_e2 <- read_excel("agg_exp2_exp3.xlsx", col_names = FALSE, range = "A12:B15")
dgn_e3 <- read_excel("agg_exp2_exp3.xlsx", col_names = FALSE, range = "A265:B268")

#Read in files related to graph paramenters
sim_e0 <- read_excel("agg_bc_exp1.xlsx",  col_names = TRUE, range = "A17:DA255")
sim_e1 <- read_excel("agg_bc_exp1.xlsx",  col_names = TRUE, range = "A270:DA508")
sim_e2 <- read_excel("agg_exp2_exp3.xlsx",  col_names = TRUE, range = "A17:DA255")
sim_e3 <- read_excel("agg_exp2_exp3.xlsx",  col_names = TRUE, range = "A270:DA508")

## VA Color Pallete
vacol <- c("#003F72", "#0083BE", "#C4262E", "#772432", "#598527", "#f3cf45","#f7955b","#839097",
             "#dcddde", "#cccc99", "#bec292")
```

```{r q_setup, include=FALSE}
rsh_ord <- c("Our Question:", "Our Hypothesis:", "Our Findings:", "Our Decisions:")
rsh_ord2 <- c("Our Question", "Our Hypothesis", "Our Findings", "Our Decisions")
  
  
dgn <- dgn_bc %>%
  rename(`Base Case` = X__2) %>%
  inner_join(dgn_e1, by = "X__1") %>%
  rename(`Experiment 1` = X__2) %>%
  inner_join(dgn_e2, by = "X__1") %>%
  rename(`Experiment 2` = X__2) %>%
  inner_join(dgn_e3, by = "X__1") %>%
  rename(`Experiment 3` = X__2,
         `QHFD Process` = X__1) %>%
  slice(match(rsh_ord, `QHFD Process`)) %>%
  gather("Experiment", value, -`QHFD Process`) %>%
  mutate(`QHFD Process` = sub("[[:punct:]]$", "", `QHFD Process`) #,
         #`QHFD Process` = sub("(Our )(.*)$", "\\1\\\n\\2", `QHFD Process`)
         ) %>%
  spread(`QHFD Process`, value) %>%
  select( Experiment, rsh_ord2)
  

```

```{r exp_setup, include=FALSE}
## All simulation data together
sim_all <- sim_e0 %>%
  mutate(Experiment = "Base Case") %>%
  bind_rows(cbind(sim_e1, Experiment = "Experiment 1")) %>%
  bind_rows(cbind(sim_e2, Experiment = "Experiment 2")) %>%
  bind_rows(cbind(sim_e3, Experiment = "Experiment 3")) %>%
  gather(week, values, -`Model Variables`, - Experiment) %>%
  mutate(week = gsub(".* (\\d+)$", "\\1", week),
         week = as.numeric(week)) %>%
  filter(!(`Model Variables` %in%  unique(sim_e0$`Model Variables`[is.na(sim_e0$`Week 1`)]))) %>%
  separate(`Model Variables`, c("Services", "Variables"), " - ")

## Identify Changing variable
var_pos <- (which(sim_e0$`Model Variables`== "Experiment Variables")+1) : 
  length(sim_e0$`Model Variables`)

var_exp <- sim_e0 %>%
  select(`Model Variables`, `Week 1`) %>%
  filter(row_number() %in% var_pos) %>%
  filter(!is.na(`Week 1`)) %>%
  mutate(Variable = `Model Variables`) %>%
  separate(`Model Variables`, c("Services", "Variables"), " - ") %>%
  rename(base_value = `Week 1`)

par_chng <- sim_all %>%
  filter(week == 1) %>%
  inner_join(var_exp, by = c("Services", "Variables")) %>%
  filter(Experiment != "Base Case") %>%
  mutate(chng = values - base_value) %>%
  filter(chng != 0) %>%
  select(Services, Variables,Variable, Experiment, values)


```

#### Team Experimental Design


```{r design, echo=FALSE, include=FALSE}
htmlTable(dgn, header = names(dgn), 
          total = "tspanner",
          css.total = c("border-top: 1px dash grey;",
                        "border-top: 1px dash grey;"),
          tspanner = c(rep("",4)),
          n.tspanner = c(rep(1,4)),
          rnames = FALSE, css.cell = "padding-left: 1em; padding-right: 1em;", caption ="Team Research/Experiment Design Process", align = "clll")


```


```{r design_tb, echo=FALSE, include= FALSE}
library(knitr)
library(kableExtra)

kable(dgn) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

```


```{r tab-word, echo=FALSE, warning=FALSE}
tt_ht <- hux(dgn, add_colnames = TRUE) %>%
  set_bold(1, 1:5,TRUE) %>%
  set_bottom_border(1, 1:5, TRUE) %>%
  set_bottom_border(2, 1:5, TRUE) %>%
  set_bottom_border(3, 1:5, TRUE) %>%
  set_bottom_border(4, 1:5, TRUE)  %>%
  set_wrap(TRUE)

tt_ht



```



#### Changes to Model Parameters Relative to Base Case

```{r mpar, echo=FALSE, warning=FALSE}
hux(par_chng) %>%
  select(Experiment, Variable, values) %>%
  add_colnames() %>%
  set_bold(1, 1:3,TRUE) %>%
  set_bottom_border(1, 1:3, TRUE) %>%
  set_col_width(c(0.3, 0.5, 0.2)) %>%
  set_number_format(,3,2) %>%
  #set_align(1:nrow(par_chng), 3, "right")
  map_align(by_cols("left", "left", "right"))
  

```

#### Team Graphs
#### Compare Services: Patients Waiting for Intake Evaluation

```{r graphs, echo=FALSE}
sim_all %>%
  filter(Variables == "Patients Waiting for Intake Evaluation")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```

#### Compare Services: Patients Waiting to Start a Service

```{r graphs2, echo=FALSE}
sim_all %>%
  filter(Variables == "Patients Waiting to Start a Service")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```

#### Compare Services: Patients in Service

```{r graphs3, echo=FALSE}
sim_all %>%
  filter(Variables == "Patients in Service")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```

#### Compare Services: Work Pressure

```{r graphs4, echo=FALSE}
sim_all %>%
  filter(Variables == "Work Pressure")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```

#### Compare Services: Actual Return Visit Interval

```{r graphs5, echo=FALSE}
sim_all %>%
  filter(Variables == "Actual Return Visit Interval")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```

#### Compare Services: Actual Hours Available for Service

```{r graphs6, echo=FALSE}
sim_all %>%
  filter(Variables == "Actual Hours Available for Service")  %>%
  ggplot(aes(x = week, y = values, group = Experiment, colour = Experiment)) +
  geom_line(aes(linetype = Experiment)) +
  scale_color_manual(values = vacol) +
  facet_wrap( ~ Services) +
  theme_bw() +
  theme(legend.position="top", legend.title=element_blank()) 

```
