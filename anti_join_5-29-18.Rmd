---
title: "Generating CDW minus CPT dataset"
author: "Joyce Yang"
date: "May 29, 2018"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = normalizePath("//vhapalmpncptsd1/Shared Research/TeamPSD/R"))
```



## Setting up the R environment and datasets
```{r}
#clear memory 
rm(list=ls()) 

#set working directory
setwd("//vhapalmpncptsd1/Shared Research/TeamPSD/R")

#check working directory
getwd()

# Packages required for merging CDW and CPT

library(magrittr)
library(lubridate)
library(dplyr)
library(psych)
```


```{r}
#set up both files as dataframes
comparator.df <- read.csv(file="comparatorsites_nov23_16.csv", header=TRUE) 
dropout.df <- read.csv(file="dropout.csv",header=TRUE) 

#set all variable names as lower case
names(comparator.df) <- tolower(names(comparator.df))
variable.names(comparator.df)

names(dropout.df) <- tolower(names(dropout.df))
variable.names(dropout.df)

variable.names(comparator.df)
variable.names(dropout.df)

```

```{r}
##Set variables as numeric in order to manipulate later
#set up in original CDW 

comparator.df$totalencounters<-as.numeric(comparator.df$totalencounters)
comparator.df$patientpanel<-as.numeric(comparator.df$patientpanel)
comparator.df$providerpanel<-as.numeric(comparator.df$providerpanel)
comparator.df$psychiatrists<-as.numeric(comparator.df$psychiatrists)
comparator.df$psychologists<-as.numeric(comparator.df$psychologists)
comparator.df$socialworkers<-as.numeric(comparator.df$socialworkers)
comparator.df$evalencounter<-as.numeric(comparator.df$evalencounter)
comparator.df$psychencounter<-as.numeric(comparator.df$psychencounter)
comparator.df$ptsd_ebpsyeligible<-as.numeric(comparator.df$ptsd_ebpsyeligible)
comparator.df$pe_initial_appoints<-as.numeric(comparator.df$pe_initial_appoints)
comparator.df$cpt_initial_appoints<-as.numeric(comparator.df$cpt_initial_appoints)
comparator.df$sta6acomplexity<-as.numeric(comparator.df$sta6acomplexity)
comparator.df$tmh<-as.numeric(comparator.df$tmh)
comparator.df$psychmmencounter<-as.numeric(comparator.df$psychmmencounter)
comparator.df$groupencounter<-as.numeric(comparator.df$groupencounter)
comparator.df$mmencounter<-as.numeric(comparator.df$mmencounter)
comparator.df$casemanagement<-as.numeric(comparator.df$casemanagement)
comparator.df$telephoneencounter<-as.numeric(comparator.df$telephoneencounter)
comparator.df$otherencounter<-as.numeric(comparator.df$otherencounter)
comparator.df$depression_ebpsyeligible<-as.numeric(comparator.df$depression_ebpsyeligible)
comparator.df$cbt_d_initial_appoints<-as.numeric(comparator.df$cbt_d_initial_appoints)
comparator.df$act_initial_appoints<-as.numeric(comparator.df$act_initial_appoints)
comparator.df$ipt_initial_appoints<-as.numeric(comparator.df$ipt_initial_appoints)
```


##create combined variable in comparator.df based on the variable 'year' and the variable 'quarter'
```{r}
comparator.df <- comparator.df %>% 
  mutate(year_q  = paste0(year, "-", quarter), 
         site_yq = paste0(sta6a,"-",year_q))
```

##create combined variable in dropout.df; note that quarters in comparator are fiscal year quarters with Oct 1 start

```{r}
dropout.df <- dropout.df %>% 
  mutate(date_1 = as.character(date_1),
         date_1 = as.Date(date_1, "%m/%d/%Y"),
         year = year(date_1), 
         quarter = quarter(date_1, with_year = FALSE, fiscal_start = 10),
         quarter = paste0("Q", quarter),
         year_q = paste0(year, "-", quarter)) %>% 
  mutate(site_yq = paste0(sta6a,"-",year_q)) 
```



##select the subset of comparator that we want to work with: here we are selecting for all quarters except for Q5 (i.e., Q1-4), as well as selecting for when the level of the data is read at sta6a (i.e., not examining data read in at the sta3n level) and when the stopcodes are ALL (i.e., not examining data broken down to stopcodes of SUD and PTSD)
```{r}

compsub.df <- comparator.df %>%
  filter(quarter != "Q5") %>%
  filter(level == "sta6a") %>%
  filter(stopcode == "ALL") %>% 
select(level, stopcode, quarter, year, quarteryear, sta6a, totalencounters, patientpanel, providerpanel, psychiatrists, psychologists, socialworkers, nursepractitioners, evalencounter, psychencounter, ptsd_ebpsyeligible, pe_initial_appoints, cpt_initial_appoints, site_yq, sta6acomplexity, tmh, psychmmencounter, groupencounter, mmencounter, casemanagement, telephoneencounter, otherencounter, depression_ebpsyeligible, cbt_d_initial_appoints, act_initial_appoints, ipt_initial_appoints)
  
```



##create new dataframe that merges the two datasets on the site_yq variable
```{r}
merge.df <- merge.data.frame(compsub.df, dropout.df, by = "site_yq")
summary (merge.df)
```

-------------------------------------------------------------------

##Because our collaborators requested a merged dataset to work with on their own, I have also saved a merged dataset in our folder, so occasionally I shortcut to this step of the process and read in the merged dataset:
```{r}
merge.df <- read.csv(file="merge.csv", header=TRUE)
```


##Generate another dataframe that is the comparator.df minus the selection that was merged (with the CPT dataset), in order to compare the CPT sites with other sites (i.e., CDW minus CPT; compare X with 1 - X)

```{r}
cdw_minus_merge.df <- anti_join(comparator.df, merge.df, by= "site_yq")
```

## Examine the several datasets:
# comparator.df has 182880 observations of 42 variables
# compsub.df has 19856 observations of 31 variables
# dropout.df has 4749 observations of 88 variables
# merge.df has 2882 observations of 118 variables [31 (n of variables in compsub) + 88 (n of variables in dropout) - 1 (duplicated variable site_yq that the merge was conducted on)]
# cdw_minus_merge.df = 177085 observations of 42 variables
# I'm not exactly sure why the number of observations in cdw/comparator (182880) minus the merge (2882), which is 179998 does not equal the number of observations in cdw_minus_merge (177085).  In other words, the cdw_minus_merge has 2913 fewer observations than I expected.



